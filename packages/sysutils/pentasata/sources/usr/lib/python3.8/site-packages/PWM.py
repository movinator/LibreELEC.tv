#!/usr/bin/env python3
import os
import time

class PWM:
    def __init__(self, chipnum):
        self.pwm_base   = '/sys/class/pwm/pwmchip' + str(chipnum);
        self.pwm_engine = self.pwm_base   + '/pwm0'
        self.pwm_flag   = self.pwm_base   + '/export'
        self.pwm_enable = self.pwm_engine + '/enable'
        self.pwm_pol    = self.pwm_engine + '/polarity'
        self.pwm_period = self.pwm_engine + '/period'
        self.pwm_duty   = self.pwm_engine + '/duty_cycle'
        while not os.path.exists(self.pwm_engine):
              try:
                  f = open(self.pwm_flag, 'w')
                  f.write('0')
              except:
                  pass
              finally:
                  f.close()
              time.sleep(1)
        if self.is_enabled():
            self.set_enabled(False)
        self.set_period(50005)
        self.set_polarity()
        self.set_dutycycle(100)
        self.set_enabled(True)


    def is_enabled(self):
        try:
            f = open(self.pwm_enable, 'r')
            enabled = int(f.read().strip())
        except:
            pass
        finally:
            try:
                f.close()
            except:
                pass
            finally:
                return enabled


    def set_enabled(self, enable = True):
        try:
            f = open(self.pwm_enable, 'w')
            if enable:
               f.write('1')
            else:
               f.write('0')
        except:
            pass
        finally:
            try:
                f.close();
            except:
                pass
            finally:
                del f


    def set_polarity(self, p=True):
        try:
            f = open(self.pwm_pol, 'w')
            if p:
                f.write('normal')
            else:
                f.write('inversed')
        except:
            pass
        finally:
            try:
                f.close()
            except:
                pass
            finally:
                del f


    def set_period(self, p=100000):
        try:
            f = open(self.pwm_period, 'w')
            f.write(str(p))
        finally:
            try:
                f.close()
            finally:
                self.period = int(0.95 * p)


    def get_period(self):
        try:
            f = open(self.pwm_period, 'r')
            p = int(f.read().strip())
        except:
            pass
        finally:
            try:
                f.close()
            except:
                pass
            finally:
                return p


    def set_dutycycle(self, d=100.0):
        duty = int(self.period / 100.0 * float(d));
        try:
            f = open(self.pwm_duty, 'w')
            f.write(str(duty))
        except:
            pass
        finally:
            try:
                f.close()
            except:
                pass
            finally:
                del f


if __name__ == '__main__':
    pwm = PWM(1)
    pwm.set_dutycycle(50)
